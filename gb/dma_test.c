#include <stdint.h>
#include <string.h>
#include "xprintf.h"

#define DMA   *((uint8_t *) 0xFF46)

#define VRAM_DMA_SRC_LO *((uint8_t *) 0xFF51)
#define VRAM_DMA_SRC_HI *((uint8_t *) 0xFF52)
#define VRAM_DMA_DST_LO *((uint8_t *) 0xFF53)
#define VRAM_DMA_DST_HI *((uint8_t *) 0xFF54)
#define VRAM_DMA_MODE   *((uint8_t *) 0xFF55)

#define VRAM            *((uint8_t *) 0x8000)
#define TEST_RAM        *((uint8_t *) 0xA000)
#define SPRITE_ATTR_TAB *((uint8_t *) 0xFE00)

void putc(int c)
{
    #define UART_TDR *((uint8_t *) 0xE000)
    UART_TDR = (unsigned char) c;
}

uint8_t test_data[] =
{
    0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0x80, 0xA0, 0xA0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF,
    0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0,
    0x80, 0xA0, 0xA0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF,
    0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0x80, 0xA0, 0xA0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF,
    0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0,
    0x80, 0xA0, 0xA0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF,
    0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0x80, 0xA0, 0xA0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF,
    0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0,
    0x80, 0xA0, 0xA0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF,
    0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF, 0xC0, 0x80, 0xA0, 0xA0, 0xFF, 0xFF, 0xC0, 0xFF, 0xFF,
};

void main(void)
{
    /* enabe all interrupts */
    __asm__("ei");
    *((unsigned char*)0xFFFF) = 0xff;

    xdev_out(putc);
    xprintf("Hello World!\n\n");
    xprintf("src = %04x, dst = %04x\n\n", (uint16_t) &TEST_RAM, (uint16_t) &VRAM);

    memcpy(&TEST_RAM, test_data, sizeof(test_data));

    
    VRAM_DMA_SRC_LO = (((uint16_t) &TEST_RAM) & 0x00FF) >> 0;
    VRAM_DMA_SRC_HI = (((uint16_t) &TEST_RAM) & 0xFF00) >> 8;
    VRAM_DMA_DST_LO = (((uint16_t)     &VRAM) & 0x00FF) >> 0;
    VRAM_DMA_DST_HI = (((uint16_t)     &VRAM) & 0xFF00) >> 8;
    VRAM_DMA_MODE = (sizeof(test_data) / 16) - 1;

    xprintf("%04x:\n", &VRAM);
    for (int i = 0; i < sizeof(test_data); i++)
    {
        xprintf("%02X%c", ((uint8_t *)&VRAM)[i], (0 == ((i+1) % 16)) ? '\n' : ' ');
    }

    DMA = 0xA0;

    xprintf("%04x:\n", &SPRITE_ATTR_TAB);
    for (int i = 0; i < sizeof(test_data); i++)
    {
        xprintf("%02X%c", ((uint8_t *)&SPRITE_ATTR_TAB)[i], (0 == ((i+1) % 16)) ? '\n' : ' ');
    }

    __asm__("stop");
    return;
}